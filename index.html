<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê±´ê°• ì ìˆ˜ ê³„ì‚°ê¸°</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fff; padding: 20px; }
    .container { max-width: 500px; margin: auto; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; font-size: 24px; margin-bottom: 20px; }
    .group { margin-top: 18px; }
    label { font-weight: bold; font-size: 15px; }
    .options { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .option-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #f2f2f2;
      cursor: pointer;
      font-size: 14px;
    }
    .option-btn.selected {
      background: #0068ff;
      color: white;
      font-weight: bold;
      border-color: #0068ff;
    }

    #bmiBox { margin-top:10px; display: flex; gap:10px; }
    #bmiBox input { width:50%; padding: 8px; border-radius:6px; border:1px solid #ccc;}

    #score-box { margin-top: 25px; text-align: center; font-size: 20px; font-weight:bold; }
    #stars { font-size: 26px; color: gold; text-align:center; margin-top: 8px; }

    button#checkBtn {
      width: 100%;
      padding: 14px;
      background: #0068ff;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      margin-top: 20px;
      cursor: pointer;
    }

    #chart-container { margin-top: 35px; }
  </style>
</head>
<body>

<div class="container">
  <h2>ê±´ê°• ì ìˆ˜ ê³„ì‚°ê¸°</h2>

  <label>ì´ë¦„</label>
  <input type="text" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #ccc;">

  <!-- ì ìˆ˜ ì„ íƒ ì˜ì—­ -->
  <div class="group">
    <label>í¡ì—°</label>
    <div class="options" data-group="í¡ì—°">
      <button class="option-btn" data-score="3">ë‹´ë°° í•€ë‹¤</button>
      <button class="option-btn" data-score="5">ë‹´ë°° ì•ˆí•€ë‹¤</button>
    </div>
  </div>

  <div class="group">
    <label>ê±¸ìŒìˆ˜</label>
    <div class="options" data-group="ê±¸ìŒìˆ˜">
      <button class="option-btn" data-score="1">&lt;2000</button>
      <button class="option-btn" data-score="2">2000â€“5000</button>
      <button class="option-btn" data-score="3">5000â€“8000</button>
      <button class="option-btn" data-score="4">8000â€“12000</button>
      <button class="option-btn" data-score="5">&ge;12000</button>
    </div>
  </div>

  <div class="group">
    <label>LDL</label>
    <div class="options" data-group="LDL">
      <button class="option-btn" data-score="1">&ge;190</button>
      <button class="option-btn" data-score="2">160â€“189</button>
      <button class="option-btn" data-score="3">130â€“159</button>
      <button class="option-btn" data-score="4">100â€“129</button>
      <button class="option-btn" data-score="5">&lt;100</button>
    </div>
  </div>

  <div class="group">
    <label>í˜ˆì••</label>
    <div class="options" data-group="í˜ˆì••">
      <button class="option-btn" data-score="1">&ge;160/100</button>
      <button class="option-btn" data-score="2">140/90â€“159/99</button>
      <button class="option-btn" data-score="3">130/85â€“139/89</button>
      <button class="option-btn" data-score="4">120/80â€“129/84</button>
      <button class="option-btn" data-score="5">&lt;120/80</button>
    </div>
  </div>

  <div class="group">
    <label>BMI</label>
    <div id="bmiBox">
      <input type="number" id="weight" placeholder="ì²´ì¤‘ (kg)">
      <input type="number" id="height" placeholder="ì‹ ì¥ (cm)">
    </div>
    <div class="options" data-group="BMI" style="margin-top:10px;">
      <button class="option-btn" data-score="5">ì •ìƒ (18.5â€“25)</button>
      <button class="option-btn" data-score="4">&lt;18.5 ë˜ëŠ” 25â€“30</button>
      <button class="option-btn" data-score="3">30â€“35</button>
      <button class="option-btn" data-score="2">35â€“40</button>
      <button class="option-btn" data-score="1">&ge;40</button>
    </div>
  </div>

  <!-- í˜„ì¬ ì ìˆ˜ í‘œì‹œ -->
  <div id="score-box">ì´ì : -</div>
  <div id="stars"></div>

  <button id="checkBtn">ê±´ê°•ì ìˆ˜ í™•ì¸í•˜ê¸°</button>

  <div id="chart-container">
    <canvas id="chart"></canvas>
  </div>

</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/********** â˜… ë°˜ë“œì‹œ ë³¸ì¸ ìŠ¤í¬ë¦½íŠ¸ URLë¡œ ë³€ê²½ â˜… **********/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCrGwDISQh1VEL92ku0cMPoy7eY9m4768NiQZzBV3uxDS1rVj9YGJEMle5HDt7ngGn/exec";

/********** ë²„íŠ¼ ì„ íƒ UI **********/
document.querySelectorAll(".options").forEach(group=>{
  group.addEventListener("click",e=>{
    if(!e.target.classList.contains("option-btn"))return;
    [...group.children].forEach(btn=>btn.classList.remove("selected"));
    e.target.classList.add("selected");
    updateScoreUI();
  });
});

/********** ì ìˆ˜ ê³„ì‚° â†’ UI ì¦‰ì‹œ ê°±ì‹  **********/
function updateScoreUI(){
  const groups=["í¡ì—°","ê±¸ìŒìˆ˜","LDL","í˜ˆì••","BMI"];
  let sum=0;
  groups.forEach(g=>{
    const sel=document.querySelector(`.options[data-group="${g}"] .selected`);
    if(sel){ sum+=Number(sel.dataset.score); }
  });

  document.getElementById("score-box").innerText = "ì´ì : " + sum + "ì ";
  document.getElementById("stars").innerHTML = "â˜…".repeat(sum) + "â˜†".repeat(25-sum);
}

/********** ë²„íŠ¼ í´ë¦­ â†’ ì €ì¥ + ê·¸ë˜í”„ í‘œì‹œ **********/
document.getElementById("checkBtn").addEventListener("click",async()=>{
  const name=document.getElementById("name").value.trim();
  if(!name)return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

  const groups=["í¡ì—°","ê±¸ìŒìˆ˜","LDL","í˜ˆì••","BMI"];
  let scores={};
  for(let g of groups){
    const sel=document.querySelector(`.options[data-group="${g}"] .selected`);
    if(!sel)return alert(`${g} í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!`);
    scores[g]=Number(sel.dataset.score);
  }

  const totalScore = scores.í¡ì—° + scores.ê±¸ìŒìˆ˜ + scores.LDL + scores.í˜ˆì•• + scores.BMI;

  /* ğŸ”§ ì—¬ê¸° ë¶€ë¶„ë§Œ ìˆ˜ì •ë¨ (í•œê¸€ key â†’ ì˜ë¬¸ key ë§¤í•‘) */
  await fetch(SCRIPT_URL,{
    method:"POST",
    body: JSON.stringify({
      mode: "save",
      name,
      smoking: scores["í¡ì—°"],
      steps: scores["ê±¸ìŒìˆ˜"],
      ldl: scores["LDL"],
      bp: scores["í˜ˆì••"],
      bmi: scores["BMI"],
      totalScore
    })
  });

  alert(`ì´ì  ${totalScore}ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  loadChart(name);
});

/********** GET ì¡°íšŒ â†’ ê·¸ë˜í”„ ìƒì„± **********/
async function loadChart(name){
  const res=await fetch(`${SCRIPT_URL}?mode=get&name=${encodeURIComponent(name)}`);
  const json=await res.json();
  if(json.status!=="ok")return;

  const byDate={};
  json.data.forEach(d=>{
    if(!byDate[d.date] || d.totalScore > byDate[d.date]) byDate[d.date]=d.totalScore;
  });

  const rows=Object.entries(byDate).sort((a,b)=>a[0]>b[0]?1:-1);
  const sliced=rows.slice(-4);
  const labels=sliced.map(r=>r[0]);
  const scores=sliced.map(r=>r[1]);

  drawChart(labels,scores);
}

/********** ì°¨íŠ¸ ë Œë”ë§ **********/
let chart;
function drawChart(labels,scores){
  const ctx=document.getElementById("chart").getContext("2d");
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:"line",
    data:{ labels, datasets:[{label:"ê±´ê°• ì ìˆ˜ ë³€í™”",data:scores,borderWidth:2,borderColor:"#0068ff",tension:0.2}] }
  });
}
</script>

</body>
</html>
